pipeline{
    agent any
    environment {
        CONTAINER_NAME = "nestjs-app"
        IMAGE_NAME = 'nestcore-app'
        EMAIL = "nauman170462@gmail.com"
        PORT = "3000"
    }
    stages{
        stage('Clone Repo'){
            steps{
               git branch : 'main', url: 'https://github.com/bsce20028/Nest-Concepts.git'
            }
        }
        stage('Build Docker Image'){
            steps{
                script{
                    sh "docker build -t ${IMAGE_NAME} ."
                }
            }
        }
        stage('Stop & Remove Previous Container'){
            steps{
              sh'''
                  docker stop ${CONTAINER_NAME} || true
                  docker rm ${CONTAINER_NAME} || true
                '''
            }
        }
        stage('Run Docker Container'){
            steps{
              sh'''
                  docker run -d -p ${PORT}:${PORT} --name ${CONTAINER_NAME} ${IMAGE_NAME}
                '''
            }
        }
        stage('Send Email Notification'){
            steps{
              emailext(
                subject: "Deployment Successful on EC2: ${IMAGE_NAME}",
                body: "The Docker container ${CONTAINER_NAME} has been successfully deployed and is running on port ${PORT}.",
                http: //13.210.14.76:${PORT}/
                to: "${EMAIL}"
              )
            }
        }
    } 
}